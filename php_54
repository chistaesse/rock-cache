FROM romeoz/docker-phpfpm:5.4
MAINTAINER romeOz <serggalka@gmail.com>

WORKDIR /tmp/

RUN	\
	VERSION_PECL_COUCHBASE="2.1.0"  && BUILD_DEPS='php5-dev make libtool locate wget pkg-config' \
    && apt-get update \
    && apt-get install -y ${BUILD_DEPS} \
    && apt-get update \
    && echo "deb http://packages.couchbase.com/ubuntu trusty trusty/main" | tee -a /etc/apt/sources.list.d/couchbase.list \
    && wget -O- http://packages.couchbase.com/ubuntu/couchbase.key | sudo apt-key add - \
	&& apt-get update \
	&& apt-get install -y git libcouchbase2-libevent libcouchbase-dev libsasl2-dev libmemcached-dev php5-memcache \
	&& pecl channel-update pecl.php.net \
	# Install xdebug
	&& echo -e "\nInstall xdebug extension\n" \
	&& pecl install -f xdebug-2.3.2 \
	&& PATH_XDEBUG=$(updatedb && locate xdebug.so) \
	&& echo "zend_extension = ${PATH_XDEBUG}" >> /etc/php5/fpm/conf.d/xdebug.ini \
	# Install memcached
	&& echo -e "\nInstall memcached extension\n" \
	&& printf "no --disable-memcached-sasl" | pecl install memcached \
	&& echo "extension = memcached.so" >> /etc/php5/fpm/conf.d/memcached.ini \
	# Install couchbase
	&& echo -e "\nInstall couchbase extension\n" \
	&& pecl install -f couchbase-${VERSION_PECL_COUCHBASE} \
	&& echo "extension = couchbase.so" >> /etc/php5/fpm/conf.d/couchbase.ini \
	# Install redis
	&& echo -e "\nInstall redis extension\n" \
	&& pecl install redis \
	&& echo "extension = redis.so" >> /etc/php5/fpm/conf.d/redis.ini \
	# Install mongo
	&& echo -e "\nInstall mongo extension\n" \
	&& printf "\n" | pecl install mongo \
	&& echo "extension = mongo.so" >> /etc/php5/fpm/conf.d/mongo.ini \
	# Install composer
	&& curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer \
	# Cleaning
	&& apt-get purge -y --auto-remove ${BUILD_DEPS} \
	&& apt-get autoremove -y && apt-get clean \
	&& rm -rf /var/lib/apt/lists/*

WORKDIR /var/www

EXPOSE 9000

CMD ["/usr/sbin/php5-fpm"]