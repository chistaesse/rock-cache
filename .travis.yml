sudo: required

env:
  - DOCKERFILE=php_55
  - DOCKERFILE=php_56
#matrix:
#  fast_finish: true
#  allow_failures:
#    - php: 7.0
#    - php: hhvm
#    - php: hhvm-nightly

services:
  - docker

#addons:
#  apt:
#    sources:
#      - couchbase-precise
#    packages:
#      - autoconf
#      - libcouchbase-dev
#      - libcouchbase2-libevent
#      - php-pear
#      - php5-dev

before_install:
  - docker build -f $DOCKERFILE -t rock-cache .
  - docker run --name couchbase -d couchbase/server:community-3.0.1
  - docker run --name redis -d romeoz/docker-redis:2.8
  - docker run --name memcached -d romeoz/docker-memcached
  - docker run --name mongodb -d romeoz/docker-mongodb:2.6
  - docker run --name app -d --link couchbase:couchbase --link redis:redis --link memcached:memcached --link mongodb:mongodb -v $(pwd):/var/www rock-cache
  - docker ps -a

install:
  - chmod -R +x tests/data/travis/
  - travis_retry docker exec -it couchbase bash -c '/opt/couchbase/bin/couchbase-cli bucket-create -c 127.0.0.1:8091 --bucket=default --bucket-type=memcached --bucket-ramsize=64 --enable-flush=1 -u demo -p demo'
  - tests/data/travis/mongodb-setup.sh
  - docker exec -it app bash -c 'composer install --prefer-dist && composer require satooshi/php-coveralls:*@dev && mkdir -p build/logs'
  - docker exec -it app bash -c 'vendor/bin/phpunit --verbose --coverage-clover build/logs/clover.xml --exclude-group hhvm && vendor/bin/coveralls -v'
#install:
#  - docker exec -it couchbase bash -c '/opt/couchbase/bin/couchbase-cli bucket-create -c 127.0.0.1:8091 --bucket=default --bucket-type=memcached --bucket-ramsize=64 --enable-flush=1 -u demo -p demo'
#  - docker exec -it app bash -c 'composer install --prefer-dist && composer require satooshi/php-coveralls:*@dev && mkdir -p build/logs'
#  - docker exec -it app bash -c 'vendor/bin/phpunit --verbose --coverage-clover build/logs/clover.xml --exclude-group hhvm'

#before_script:
#  - mongo rocktest --eval 'db.addUser("travis", "test");'

#script:
#  - mkdir -p build/logs
#  - |
#    if (php --version | grep -i HipHop > /dev/null); then
#      vendor/bin/phpunit --verbose --exclude-group php,redis,apc,couchbase,mongodb
#    else
#      vendor/bin/phpunit --verbose --coverage-clover build/logs/clover.xml --exclude-group hhvm
#    fi
#
#after_script:
#  - vendor/bin/coveralls -v
