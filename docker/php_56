FROM romeoz/docker-phpfpm:5.6
MAINTAINER romeOz <serggalka@gmail.com>

ENV PHP_CONF_DIR=/etc/php/5.6

WORKDIR /tmp/

RUN	\
	VERSION_PECL_COUCHBASE="2.1.0" && BUILD_DEPS='php5.6-dev wget' \
    && apt-get update \
    && apt-get install -y ${BUILD_DEPS} \
    && echo "deb http://packages.couchbase.com/ubuntu trusty trusty/main" | tee -a /etc/apt/sources.list.d/couchbase.list \
    && wget -O- http://packages.couchbase.com/ubuntu/couchbase.key | apt-key add - \
	&& apt-get update \
	&& apt-get install -y git libcouchbase2-libevent libcouchbase-dev php-xdebug php-redis php-memcache php-memcached php-apcu php-mongo \
    && echo "apc.enable_cli=1" >> ${PHP_CONF_DIR}/mods-available/apcu.ini \
    && pecl channel-update pecl.php.net \
	# Install couchbase
	&& echo "\nInstall couchbase extension\n" \
	&& pecl install -f couchbase-${VERSION_PECL_COUCHBASE} \
	&& echo "extension = couchbase.so" >> ${PHP_CONF_DIR}/fpm/conf.d/couchbase.ini \
	&& echo "extension = couchbase.so" >> ${PHP_CONF_DIR}/cli/conf.d/couchbase.ini \
	# Install composer
	&& echo "\nInstall composer\n" \
	&& curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer \
	# Cleaning
	&& apt-get purge -y --auto-remove ${BUILD_DEPS} \
	&& apt-get autoremove -y && apt-get clean \
	&& rm -rf /var/lib/apt/lists/*

WORKDIR /var/www

EXPOSE 9000

CMD ["/usr/sbin/php-fpm5.6"]